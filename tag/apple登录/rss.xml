<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>Molier • Posts by &#34;apple登录&#34; tag</title>
        <link>https://oliverqueen.cn</link>
        <description>iOS 开发 移动App 博客 杂谈 随笔 相册</description>
        <language>zh-CN</language>
        <pubDate>Thu, 26 May 2022 10:53:20 +0800</pubDate>
        <lastBuildDate>Thu, 26 May 2022 10:53:20 +0800</lastBuildDate>
        <category>欢迎页</category>
        <category>网络</category>
        <category>底层</category>
        <category>DNS解析</category>
        <category>LocalDNS</category>
        <category>OpenGL</category>
        <category>UI</category>
        <category>动画</category>
        <category>性能优化</category>
        <category>xcode</category>
        <category>cocoapods</category>
        <category>podfile</category>
        <category>webview</category>
        <category>hook</category>
        <category>runtime</category>
        <category>翻译</category>
        <category>优化</category>
        <category>国外文献</category>
        <category>httpdns</category>
        <category>Cocoapods</category>
        <category>架构</category>
        <category>AlertView</category>
        <category>Hook</category>
        <category>杂谈</category>
        <category>Hexo</category>
        <category>个人博客</category>
        <category>网站</category>
        <category>屏幕适配</category>
        <category>iOS 11</category>
        <category>评论插件</category>
        <category>总结</category>
        <category>回味2017展望2018</category>
        <category>热修复</category>
        <category>JSPath</category>
        <category>swift</category>
        <category>网络请求</category>
        <category>Swift</category>
        <category>音频</category>
        <category>唱吧</category>
        <category>K歌</category>
        <category>AVFoundation</category>
        <category>git</category>
        <category>效率工作</category>
        <category>回首2018展望2019</category>
        <category>代码版本控制</category>
        <category>iOS</category>
        <category>Crash防护</category>
        <category>Apple登录</category>
        <category>WWDC2022</category>
        <category>逆向</category>
        <category>算法</category>
        <category>C语言</category>
        <category>排序</category>
        <item>
            <guid isPermalink="true">https://oliverqueen.cn/2022-05-26-Apple%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/</guid>
            <title>Apple登录流程详解</title>
            <link>https://oliverqueen.cn/2022-05-26-Apple%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3/</link>
            <category>iOS</category>
            <category>Apple登录</category>
            <pubDate>Thu, 26 May 2022 10:53:20 +0800</pubDate>
            <description><![CDATA[ &lt;link rel=&#34;stylesheet&#34; class=&#34;aplayer-secondary-style-marker&#34; href=&#34;/assets/css/APlayer.min.css&#34;&gt;&lt;script src=&#34;/assets/js/APlayer.min.js&#34; class=&#34;aplayer-secondary-script-marker&#34;&gt;&lt;/script&gt;&lt;h2 id=&#34;1背景&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#1背景&#34;&gt;#&lt;/a&gt; 1：背景&lt;/h2&gt;
&lt;p&gt;2019 年苹果推出 苹果登录（Sign in with Apple）方式，要求 2020 年 4 月之后运行在 iOS13 及以上系统的 APP 如果使用第三方或社交登录服务（如 Facebook、谷歌、 Twitter、Linkedln 或亚马逊等），必须向用户提供 “以苹果账号登录” 服务的选项。其中苹果的&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9jZG4uY2RuanNvbi5jb20vdHZhMS5zaW5haW1nLmNuL2xhcmdlL2U2YzlkMjRlZ3kxaDJmempqd3d1YWoyMTY0MHA0NDRkLmpwZw==&#34;&gt;审核细则 4.8&lt;/span&gt; 也明确的规定了这一点。&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2lmep99kij21ns0rkaba.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;span id=&#34;more&#34;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;font color=&amp;quot;#dd0000&amp;quot;&amp;gt; 不过需要注意的一点是腾讯系列的产品如果只是使用微信、QQ 登录并不算第三方登录，所以可以添加 AppleID 登录方式。&amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt;&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2fzjjwwuaj21640p444d.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;h2 id=&#34;2前置配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#2前置配置&#34;&gt;#&lt;/a&gt; 2：前置配置&lt;/h2&gt;
&lt;h4 id=&#34;21-xcode工程配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#21-xcode工程配置&#34;&gt;#&lt;/a&gt; 2.1 Xcode 工程配置&lt;/h4&gt;
&lt;p&gt;选中工程 trager，在 capabilities 中添加 AppleID 登录的能力&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g28b5w8aj21960u0769.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;22-开发者账号配置&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#22-开发者账号配置&#34;&gt;#&lt;/a&gt; 2.2 开发者账号配置&lt;/h4&gt;
&lt;p&gt;基于授权码的后端验证方式需要此步骤，如果使用 JWT 验证方式则不依赖此步骤，不过建议按顺序看完多做了解。&lt;/p&gt;
&lt;p&gt;该步骤的最终目的是获取用于校验客户端身份的所需内容，其中包括以下三个内容&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;生成一个用于校验客户端身份的密钥文件&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;获取 KeyID&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;获取 iss（TeamID）&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&amp;lt;font color=&amp;quot;#dd0000&amp;quot;&amp;gt; 注意：该步骤需要登录 Apple 开发者账号并对其进行功能的配置、开启、以及描述文件更新等操作，可能需要证书管理团队或者有相关权限的人员来处理，并由他们将对应信息输出 &amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt;&lt;/p&gt;
&lt;h5 id=&#34;步骤一能力开启&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤一能力开启&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤一：能力开启&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;进入开发者账号，选择需要支持 AppleID 登录能力的应用并进入打开其 AppleID 登录的功能&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g335dozbj219o0kiwg6.jpg&#34; alt=&#34;&#34; /&gt;&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g36gha89j216x0u0gnx.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;步骤二更新profile&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤二更新profile&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤二：更新 profile&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;对 app 的任何更改都会导致现有的 profile 文件失效，所以需要重新生成 profile 描述文件。&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g38wg6kij20ia08qmxk.jpg&#34; alt=&#34;&#34; /&gt;&lt;br /&gt;
按照如下路径操作，点进已经 &lt;code&gt;invalid&lt;/code&gt;  的描述文件并重新生成&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3em4u2oj21fq0lc75x.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;h5 id=&#34;步骤三生成密钥文件&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤三生成密钥文件&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤三：生成密钥文件&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;进入如下界面点击 &lt;code&gt;加号&lt;/code&gt; 进行生成&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3hh2cz2j216m0ms406.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;填完并勾选 &lt;code&gt;Sigin with apple&lt;/code&gt;  后点击右侧的 &lt;code&gt;Configure&lt;/code&gt;  进行配置，在配置页面选择需要开启苹果登录的 app 并保存，然后回到上一页并开始注册&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3kyolw0j21m10u043i.jpg&#34; alt=&#34;&#34; /&gt;&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3ps0bfjj21v70u0td1.jpg&#34; alt=&#34;&#34; /&gt;&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3qw6gvmj22120s0dkq.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;最终注册成功后会有 KeyID、TeamID 和可供下载的密钥文件&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3umbtqzj21wg0s4gqg.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;密钥文件格式为.p8 实际是文本文件&lt;br /&gt;
&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g3yn74llj212g0badht.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;font color=&amp;quot;#dd0000&amp;quot;&amp;gt; 注意：密钥文件只能被下载一次，下载后保存在安全的地方，丢了的话只能重新申请了 &amp;lt;/font&amp;gt;&amp;lt;br /&amp;gt;&lt;/p&gt;
&lt;h2 id=&#34;3登录流程&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#3登录流程&#34;&gt;#&lt;/a&gt; 3：登录流程&lt;/h2&gt;
&lt;p&gt;登录流程分两大块，一个是客户端部分，一个是后端部分，其中后端部分有两种校验方式 &lt;code&gt;基于授权码的后端验证&lt;/code&gt; 、 &lt;code&gt;基于JWT的算法验证&lt;/code&gt; ，稍后会一一讲解。总体流程如下图：&lt;/p&gt;
&lt;p&gt;&lt;img data-src=&#34;https://cdn.cdnjson.com/tva1.sinaimg.cn/large/e6c9d24egy1h2g4un5dizj20ve0u0dip.jpg&#34; alt=&#34;&#34; /&gt;&lt;/p&gt;
&lt;h4 id=&#34;31-客户端侧&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#31-客户端侧&#34;&gt;#&lt;/a&gt; 3.1 客户端侧&lt;/h4&gt;
&lt;h5 id=&#34;步骤一授权&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤一授权&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤一：授权&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;对于客户端来说 AppleID 登录与传统的三方登录流程一样，分为 &lt;code&gt;调用接口&lt;/code&gt; 与 &lt;code&gt;回调信息获取&lt;/code&gt; 两步，唯一不同点是苹果登录的 API 是在 iOS SDK 内部封装，只用导入对应头文件即可&lt;br /&gt;
 &lt;code&gt;#import &amp;lt;AuthenticationServices/AuthenticationServices.h&amp;gt; &lt;/code&gt;&lt;/p&gt;
&lt;p&gt;关于登录入口，苹果对 AppleID 登录的 UI 有严格的限制，因此专门提供了提供了一套继承于 &lt;code&gt;UIControl&lt;/code&gt;  等控件来供开发者使用 &lt;code&gt;ASAuthorizationAppleIDButton&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;figure class=&#34;highlight objectivec&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;ASAuthorizationAppleIDButton * appleIDBtn = [ASAuthorizationAppleIDButton buttonWithType:ASAuthorizationAppleIDButtonTypeDefault style:ASAuthorizationAppleIDButtonStyleWhite];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;appleIDBtn.frame = &lt;span class=&#34;built_in&#34;&gt;CGRectMake&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;0&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;100&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;60&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[appleIDBtn addTarget:&lt;span class=&#34;keyword&#34;&gt;self&lt;/span&gt; action:&lt;span class=&#34;keyword&#34;&gt;@selector&lt;/span&gt;(didAppleIDBtnClicked) forControlEvents:&lt;span class=&#34;built_in&#34;&gt;UIControlEventTouchUpInside&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;[&lt;span class=&#34;keyword&#34;&gt;self&lt;/span&gt;.view addSubview:appleIDBtn];&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;其中按钮的 &lt;code&gt;文案类型&lt;/code&gt; 和 &lt;code&gt;UI风格&lt;/code&gt; 可以通过枚举进行配置&lt;br /&gt;
 &lt;figure class=&#34;highlight elm&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;//  文案类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;typedef &lt;span class=&#34;type&#34;&gt;NS_ENUM&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;NSInteger&lt;/span&gt;, &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonType&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonTypeSignIn&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonTypeContinue&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonTypeSignUp&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;API_AVAILABLE&lt;/span&gt;(ios(13.2), macos(10.15.1), tvos(13.1)) &lt;span class=&#34;type&#34;&gt;API_UNAVAILABLE(watchos)&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonTypeDefault&lt;/span&gt; = &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonTypeSignIn&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;type&#34;&gt;NS_SWIFT_NAME&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButton&lt;/span&gt;.&lt;span class=&#34;type&#34;&gt;ButtonType&lt;/span&gt;) &lt;span class=&#34;type&#34;&gt;API_AVAILABLE&lt;/span&gt;(ios(13.0), macos(10.15), tvos(13.0)) &lt;span class=&#34;type&#34;&gt;API_UNAVAILABLE&lt;/span&gt;(watchos);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;//  &lt;span class=&#34;type&#34;&gt;UI&lt;/span&gt;风格&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;typedef &lt;span class=&#34;type&#34;&gt;NS_ENUM&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;NSInteger&lt;/span&gt;, &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonStyle&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonStyleWhite&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonStyleWhiteOutline&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButtonStyleBlack&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;type&#34;&gt;NS_SWIFT_NAME&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDButton&lt;/span&gt;.&lt;span class=&#34;type&#34;&gt;Style&lt;/span&gt;) &lt;span class=&#34;type&#34;&gt;API_AVAILABLE&lt;/span&gt;(ios(13.0), macos(10.15), tvos(13.0)) &lt;span class=&#34;type&#34;&gt;API_UNAVAILABLE&lt;/span&gt;(watchos);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;br /&gt;
 但是并不推荐这种方式使用，原因如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1：固定 UI 无法满足业务的定制化需求&lt;/li&gt;
&lt;li&gt;2：文案固定，多语言配置需要在单独的地方去配置文案&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;所以建议自己写 UI，直接在点击事件中调用 AppleID 的相关 API 进行授权登陆操作，具体代码为，其中 &lt;code&gt;ASAuthorizationAppleIDRequest&lt;/code&gt;  为是否使用 Keychain 信息，如果如果 KeyChain 里面也有登录信息的话，可以直接使用里面保存的用户名和密码进行登录。可以根据实际业务需求来&lt;br /&gt;
 &lt;figure class=&#34;highlight swift&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;type&#34;&gt;KINFO&lt;/span&gt;(@&lt;span class=&#34;string&#34;&gt;&amp;quot;[AppleLoginWrapper]开始苹果登录鉴权&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;@available&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;iOS&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;13.0&lt;/span&gt;, &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProvider&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;provider &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [&lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProvider&lt;/span&gt; new];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDRequest&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;request &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [provider createRequest];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    request.requestedScopes &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; @[ &lt;span class=&#34;type&#34;&gt;ASAuthorizationScopeFullName&lt;/span&gt;, &lt;span class=&#34;type&#34;&gt;ASAuthorizationScopeEmail&lt;/span&gt; ]; &lt;span class=&#34;comment&#34;&gt;//请求的用户信息&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationPasswordRequest&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; keychainRequest &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [[[&lt;span class=&#34;type&#34;&gt;ASAuthorizationPasswordProvider&lt;/span&gt; alloc] &lt;span class=&#34;keyword&#34;&gt;init&lt;/span&gt;] createRequest];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;ASAuthorizationController&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;vc &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [[&lt;span class=&#34;type&#34;&gt;ASAuthorizationController&lt;/span&gt; alloc] initWithAuthorizationRequests:@[ request ,keychainRequest]];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    vc.delegate &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    vc.presentationContextProvider &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;self&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    [vc performRequests];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Fallback on earlier versions&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;type&#34;&gt;KINFO&lt;/span&gt;(@&lt;span class=&#34;string&#34;&gt;&amp;quot;[AppleLoginWrapper]iOS系统低于13&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h5 id=&#34;步骤二信息回调&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤二信息回调&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤二：信息回调&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;依赖的两个 delegate&lt;br /&gt;
&lt;figure class=&#34;highlight objectivec&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;pragma&lt;/span&gt; mark- 代理 ASAuthorizationControllerDelegate&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- (&lt;span class=&#34;type&#34;&gt;void&lt;/span&gt;)authorizationController:(ASAuthorizationController *)controller didCompleteWithAuthorization:(ASAuthorization *)authorization &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;//  成功&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;//  其中`authorization.credential`包含了Token，用户ID等授权所需信息，可上报到后台&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- (&lt;span class=&#34;type&#34;&gt;void&lt;/span&gt;)authorizationController:(ASAuthorizationController *)controller didCompleteWithError:(&lt;span class=&#34;built_in&#34;&gt;NSError&lt;/span&gt; *)error &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;//  失败&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;#&lt;span class=&#34;keyword&#34;&gt;pragma&lt;/span&gt; mark- 代理ASAuthorizationControllerPresentationContextProviding&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- (ASPresentationAnchor)presentationAnchorForAuthorizationController:(ASAuthorizationController *)controller &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;//  展示在哪个Window上&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;keyword&#34;&gt;self&lt;/span&gt;.view.window;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h5 id=&#34;步骤三用户id状态校验&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#步骤三用户id状态校验&#34;&gt;#&lt;/a&gt; &lt;strong&gt;步骤三：用户 ID 状态校验&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;防止用户注销 AppleId 或 停止使用 Apple ID 的状态处理&lt;br /&gt;
 &lt;figure class=&#34;highlight swift&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;28&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;operator&#34;&gt;-&lt;/span&gt; (&lt;span class=&#34;type&#34;&gt;BOOL&lt;/span&gt;)application:(&lt;span class=&#34;type&#34;&gt;UIApplication&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;)application didFinishLaunchingWithOptions:(&lt;span class=&#34;type&#34;&gt;NSDictionary&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;)launchOptions &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;comment&#34;&gt;// Override point for customization after application launch.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;@available&lt;/span&gt;(&lt;span class=&#34;keyword&#34;&gt;iOS&lt;/span&gt; &lt;span class=&#34;number&#34;&gt;13.0&lt;/span&gt;, &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;comment&#34;&gt;// 注意 存储用户标识信息需要使用钥匙串来存储 这里使用NSUserDefaults 做的简单示例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;type&#34;&gt;NSString&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; userIdentifier &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [[&lt;span class=&#34;type&#34;&gt;NSUserDefaults&lt;/span&gt; standardUserDefaults] valueForKey:@&lt;span class=&#34;string&#34;&gt;&amp;quot;appleID&amp;quot;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (userIdentifier) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProvider&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; appleIDProvider &lt;span class=&#34;operator&#34;&gt;=&lt;/span&gt; [[&lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProvider&lt;/span&gt; alloc] &lt;span class=&#34;keyword&#34;&gt;init&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            [appleIDProvider getCredentialStateForUserID:userIdentifier&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                                              completion:&lt;span class=&#34;operator&#34;&gt;^&lt;/span&gt;(&lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProviderCredentialState&lt;/span&gt; credentialState, &lt;span class=&#34;type&#34;&gt;NSError&lt;/span&gt; &lt;span class=&#34;operator&#34;&gt;*&lt;/span&gt; _Nullable error) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;keyword&#34;&gt;switch&lt;/span&gt; (credentialState) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProviderCredentialAuthorized&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;comment&#34;&gt;// 授权状态有效&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProviderCredentialRevoked&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;comment&#34;&gt;// 苹果账号登录的凭据已被移除，需解除绑定并重新引导用户使用苹果登录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProviderCredentialNotFound&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;comment&#34;&gt;// 未登录授权，直接弹出登录页面，引导用户登录&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                    &lt;span class=&#34;keyword&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;ASAuthorizationAppleIDProviderCredentialTransferred&lt;/span&gt;:&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;comment&#34;&gt;// 授权AppleID提供者凭据转移&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                        &lt;span class=&#34;keyword&#34;&gt;break&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;type&#34;&gt;YES&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;h4 id=&#34;32-sever侧&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#32-sever侧&#34;&gt;#&lt;/a&gt; 3.2 Sever 侧&lt;/h4&gt;
&lt;p&gt;基于上面流程图，Sever 侧校验 Token 有效性的方式有两种：&lt;/p&gt;
&lt;h5 id=&#34;方式一基于授权码的后端验证&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#方式一基于授权码的后端验证&#34;&gt;#&lt;/a&gt; &lt;strong&gt;方式一：基于授权码的后端验证&lt;/strong&gt;&lt;/h5&gt;
&lt;p&gt;后端在收到客户端传递的包含 token 的信息后进行验证&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;构建 client_secret&lt;br /&gt;
&lt;figure class=&#34;highlight reasonml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;25&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;-----BEGIN PRIVATE KEY-----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;BASE64编码后的密钥 (步骤&lt;span class=&#34;number&#34;&gt;2.2&lt;/span&gt;中获得)&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;-----END PRIVATE KEY-----&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt; &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;public  byte&lt;span class=&#34;literal&#34;&gt;[]&lt;/span&gt; read&lt;span class=&#34;constructor&#34;&gt;Key()&lt;/span&gt; throws Exception &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    String temp = &lt;span class=&#34;string&#34;&gt;&amp;quot;密钥文件中间的编码字符串&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    return &lt;span class=&#34;module-access&#34;&gt;&lt;span class=&#34;module&#34;&gt;&lt;span class=&#34;identifier&#34;&gt;Base64&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;decode&lt;span class=&#34;constructor&#34;&gt;Base64(&lt;span class=&#34;params&#34;&gt;temp&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;构建client_secret关键代码：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;String client_id = &lt;span class=&#34;string&#34;&gt;&amp;quot;...&amp;quot;&lt;/span&gt;; &lt;span class=&#34;comment&#34;&gt;// 被授权的APP ID(步骤2.2中获得)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Map&amp;lt;String, Object&amp;gt; header = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; HashMap&amp;lt;String, Object&amp;gt;&lt;span class=&#34;literal&#34;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;header.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;kid&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;密钥id&amp;quot;&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;// 参考后台配置(步骤2.2中获得)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;Map&amp;lt;String, Object&amp;gt; claims = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; HashMap&amp;lt;String, Object&amp;gt;&lt;span class=&#34;literal&#34;&gt;()&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;claims.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;iss&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;team id&amp;quot;&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;// 参考后台配置 team id(步骤2.2中获得)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;long now = &lt;span class=&#34;module-access&#34;&gt;&lt;span class=&#34;module&#34;&gt;&lt;span class=&#34;identifier&#34;&gt;System&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;current&lt;span class=&#34;constructor&#34;&gt;TimeMillis()&lt;/span&gt;&lt;span class=&#34;operator&#34;&gt; / &lt;/span&gt;&lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;claims.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;iat&amp;quot;&lt;/span&gt;, now);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;claims.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;exp&amp;quot;&lt;/span&gt;, now + &lt;span class=&#34;number&#34;&gt;86400&lt;/span&gt;&lt;span class=&#34;operator&#34;&gt; * &lt;/span&gt;&lt;span class=&#34;number&#34;&gt;30&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;// 最长半年，单位秒&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;claims.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;aud&amp;quot;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;quot;https://appleid.apple.com&amp;quot;&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;// 默认值&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;claims.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;sub&amp;quot;&lt;/span&gt;, client_id);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PKCS8EncodedKeySpec pkcs8EncodedKeySpec = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;constructor&#34;&gt;PKCS8EncodedKeySpec(&lt;span class=&#34;params&#34;&gt;readKey&lt;/span&gt;()&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;KeyFactory keyFactory = &lt;span class=&#34;module-access&#34;&gt;&lt;span class=&#34;module&#34;&gt;&lt;span class=&#34;identifier&#34;&gt;KeyFactory&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;get&lt;span class=&#34;constructor&#34;&gt;Instance(&lt;span class=&#34;string&#34;&gt;&amp;quot;EC&amp;quot;&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;PrivateKey privateKey = keyFactory.generate&lt;span class=&#34;constructor&#34;&gt;Private(&lt;span class=&#34;params&#34;&gt;pkcs8EncodedKeySpec&lt;/span&gt;)&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;String client_secret = &lt;span class=&#34;module-access&#34;&gt;&lt;span class=&#34;module&#34;&gt;&lt;span class=&#34;identifier&#34;&gt;Jwts&lt;/span&gt;.&lt;/span&gt;&lt;/span&gt;builder&lt;span class=&#34;literal&#34;&gt;()&lt;/span&gt;.set&lt;span class=&#34;constructor&#34;&gt;Header(&lt;span class=&#34;params&#34;&gt;header&lt;/span&gt;)&lt;/span&gt;.set&lt;span class=&#34;constructor&#34;&gt;Claims(&lt;span class=&#34;params&#34;&gt;claims&lt;/span&gt;)&lt;/span&gt;.sign&lt;span class=&#34;constructor&#34;&gt;With(SignatureAlgorithm.ES256, &lt;span class=&#34;params&#34;&gt;privateKey&lt;/span&gt;)&lt;/span&gt;.compact&lt;span class=&#34;literal&#34;&gt;()&lt;/span&gt;;       &lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;验证客户端 Token&lt;br /&gt;
&lt;figure class=&#34;highlight qml&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;String&lt;/span&gt; &lt;span class=&#34;built_in&#34;&gt;url&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;quot;https://appleid.apple.com/auth/token&amp;quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;comment&#34;&gt;// POST 请求&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HttpSynClient client = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; HttpSynClient(&lt;span class=&#34;number&#34;&gt;5000&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;5000&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;5000&lt;/span&gt;, &lt;span class=&#34;number&#34;&gt;20&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;built_in&#34;&gt;Map&lt;/span&gt;&amp;lt;&lt;span class=&#34;built_in&#34;&gt;String&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;String&lt;/span&gt;&amp;gt; form = &lt;span class=&#34;keyword&#34;&gt;new&lt;/span&gt; HashMap&amp;lt;&lt;span class=&#34;built_in&#34;&gt;String&lt;/span&gt;, &lt;span class=&#34;built_in&#34;&gt;String&lt;/span&gt;&amp;gt;();&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;form.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;client_id&amp;quot;&lt;/span&gt;, client_id);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;form.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;client_secret&amp;quot;&lt;/span&gt;, client_secret);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;form.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;code&amp;quot;&lt;/span&gt;, code);form.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;grant_type&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;authorization_code&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;form.put(&lt;span class=&#34;string&#34;&gt;&amp;quot;redirect_uri&amp;quot;&lt;/span&gt;, redirectUrl);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;HttpResponse result = client.excutePost(&lt;span class=&#34;built_in&#34;&gt;url&lt;/span&gt;, form);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;System.out.println(result);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;上述步骤结束后即可将结果回调给客户端，进行登录或者是错误处理
&lt;ul&gt;
&lt;li&gt;成功示例&lt;br /&gt;
 &lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;access_token&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;a0996b16cfb674c0eb0d29194c880455b.0.nsww.5fi5MVC-i3AVNhddrNg7Qw&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;token_type&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;Bearer&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;expires_in&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;number&#34;&gt;3600&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;refresh_token&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;r9ee922f1c8b048208037f78cd7dfc91a.0.nsww.KlV2TeFlTr7YDdZ0KtvEQQ&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;id_token&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;string&#34;&gt;&amp;quot;eyJraWQiOiJBSURPUEsxIiwiYWxnIjoiUlMyNTYifQ.eyJpc3MiOiJodHRwczovL2FwcGxlaWQuYXBwbGUuY29tIiwiYXVkIjoiY29tLnNreW1pbmcuYXBwbGVsb2dpbmRlbW8iLCJleHAiOjE1NjU2NjU1OTQsImlhdCI6MTU2NTY2NDk5NCwic3ViIjoiMDAwMjY2LmRiZTg2NWIwYWE3MjRlMWM4ODM5MDIwOWI5YzdkNjk1LjAyNTYiLCJhdF9oYXNoIjoiR0ZmODhlX1ptc0pqQ2VkZzJXem85ZyIsImF1dGhfdGltZSI6MTU2NTY2NDk2M30.J6XFWmbr0a1hkJszAKM2wevJF57yZt-MoyZNI9QF76dHfJvAmFO9_RP9-tz4pN4ua3BuSJpUbwzT2xFD_rBjsNWkU-ZhuSAONdAnCtK2Vbc2AYEH9n7lB2PnOE1mX5HwY-dI9dqS9AdU4S_CjzTGnvFqC9H5pt6LVoCF4N9dFfQnh2w7jQrjTic_JvbgJT5m7vLzRx-eRnlxQIifEsHDbudzi3yg7XC9OL9QBiTyHdCQvRdsyRLrewJT6QZmi6kEWrV9E21WPC6qJMsaIfGik44UgPOnNnjdxKPzxUAa-Lo1HAzvHcAX5i047T01ltqvHbtsJEZxAB6okmwco78JQA&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;li&gt;失败示例&lt;br /&gt;
 &lt;figure class=&#34;highlight json&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;attr&#34;&gt;&amp;quot;error&amp;quot;&lt;/span&gt;&lt;span class=&#34;punctuation&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;string&#34;&gt;&amp;quot;invalid_client&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;punctuation&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5 id=&#34;方式二基于jwt验证原理&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#方式二基于jwt验证原理&#34;&gt;#&lt;/a&gt; &lt;strong&gt;方式二：基于 JWT 验证原理&lt;/strong&gt;&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;获取苹果公钥，并保存&lt;/p&gt;
&lt;p&gt;用到公钥接口  &lt;code&gt;https://appleid.apple.com/auth/keys&lt;/code&gt; &lt;br /&gt;
 返回值样例&lt;br /&gt;
 &lt;figure class=&#34;highlight prolog&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&amp;#123;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;string&#34;&gt;&amp;quot;keys&amp;quot;&lt;/span&gt;: [&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;kty&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;RSA&amp;quot;&lt;/span&gt;, &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;kid&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;AIDOPK1&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;use&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;sig&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;alg&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;RS256&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;n&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;lxrwmuYSAsTfn-lUu4goZSXBD9ackM9OJuwUVQHmbZo6GW4Fu_auUdN5zI7Y1dEDfgt7m7QXWbHuMD01HLnD4eRtY-RNwCWdjNfEaY_esUPY3OVMrNDI15Ns13xspWS3q-13kdGv9jHI28P87RvMpjz_JCpQ5IM44oSyRnYtVJO-320SB8E2Bw92pmrenbp67KRUzTEVfGU4-obP5RZ09OxvCr1io4KJvEOjDJuuoClF66AT72WymtoMdwzUmhINjR0XSqK6H0MdWsjw7ysyd_JhmqX5CAaT9Pgi0J8lU_pcl215oANqjy7Ob-VMhug9eGyxAWVfu_1u6QJKePlE-w&amp;quot;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;string&#34;&gt;&amp;quot;e&amp;quot;&lt;/span&gt;: &lt;span class=&#34;string&#34;&gt;&amp;quot;AQAB&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;  &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    ]&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;验证客户端的 Token 有效性&lt;/p&gt;
&lt;p&gt;客户端会传以下几个值给服务端&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;userID：授权的用户唯一标识&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;email、fullName：授权的用户资料&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;authorizationCode：授权 code&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;identityToken：授权用户的 JWT 凭证&lt;br /&gt;
示例 identityToken：授权用户的 JWT 凭证&lt;br /&gt;
 &lt;figure class=&#34;highlight smali&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;gutter&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;eyJraWQiOiJBSURPUEsxIiwiYWxnIjoiUlMyNTYifQ.eyJpc3MiOiJodHRwczovL2FwcGxlaWQuYXBwbGUuY29tIiwiYXVkIjoiY29tLmZ1bi5BcHBsZUxvZ2luIiwiZXhwIjoxNTY4NzIxNzY5LCJpYXQiOjE1Njg3MjExNjksInN1YiI6IjAwMDU4MC4wODdjNTU0ZGNlMzU0NjZmYTg1YzVhNWQ1OTRkNTI4YS4wODAxIiwiY19oYXNoIjoiel9KY0RscFczQjJwN3ExR0Nna1JaUSIsImF1dGhfdGltZSI6MTU2ODcyMTE2OX0.WmSa4LzOzYsdwTqAJ_8mub4Ls3eyFkxZoGLoy-U7DatsTd_JEwAs3_OtV4ucmj6ENT3153iCpYY6vBxSQromOMcXsN74IrUQew24y_zflN2g4yU8ZVvBCbTrR_6p9f2fbeWjZiyNcbPCha0dv45E3vBjyHhmffWnk3vyndBBiwwuqod4pyCZ3UECf6Vu-o7dygKFpMHPS1ma60fEswY5d-_TJAFk1HaiOfFo0XbL6kwqAGvx8HnraIxyd0n8SbBVxV_KDxf15hdotUizJDW7N2XMdOGQpNFJim9SrEeBhn9741LWqkWCgkobcvYBZsrvnUW6jZ87SLi15rvIpq8_fw&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;br /&gt;
token 被解密后分为三个部分&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;header: 包括了 key id 与加密算法&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;payload:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;iss: 签发机构，苹果&lt;/li&gt;
&lt;li&gt;aud: 接收者，目标 app&lt;/li&gt;
&lt;li&gt;exp：过期时间&lt;/li&gt;
&lt;li&gt;iat: 签发时间&lt;/li&gt;
&lt;li&gt;sub: 用户 id&lt;/li&gt;
&lt;li&gt;c_hash: 一个哈希数列&lt;/li&gt;
&lt;li&gt;auth_time: 签名时间&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;signature: 用于验证 JWT 的签名&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Token 验证原理：&lt;/p&gt;
&lt;p&gt;因为 idnetityToken 使用非对称加密 RSASSA【RSA 签名算法】 和 ECDSA【椭圆曲线数据签名算法】，当验证签名的时候，利用公钥来解密 Singature，当解密内容与 base64UrlEncode (header) + “.” + base64UrlEncode (payload) 的内容完全一样的时候，表示验证通过。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;防止中间人攻击原理：&lt;/p&gt;
&lt;p&gt;该 token 是苹果利用私钥生成的一段 JWT，并给出公钥我们对 token 进行验证，由于中间人并没有苹果的私钥，所以它生成出来的 token 是没有办法利用苹果给出的公钥进行验证的，确保的 token 的安全性。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;4-总结&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#4-总结&#34;&gt;#&lt;/a&gt; 4 总结&lt;/h2&gt;
&lt;p&gt;目前使用的是基于授权码的后端验证方式，每次收到客户端登录请求后都会像苹果服务器发送 post 请求来验证，导致受网络影响较大。如果改成第一种方式后，除了获取公钥外不再依赖网络请求，可降低网络异常情况带来的损失。但是服务端要定期刷新公钥，防止公钥变化带来的验证失败&lt;/p&gt;
&lt;h2 id=&#34;5-参考文档&#34;&gt;&lt;a class=&#34;anchor&#34; href=&#34;#5-参考文档&#34;&gt;#&lt;/a&gt; 5 参考文档&lt;/h2&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kZXZlbG9wZXIub2t0YS5jb20vYmxvZy8yMDE5LzA2LzA0L3doYXQtdGhlLWhlY2staXMtc2lnbi1pbi13aXRoLWFwcGxl&#34;&gt;https://developer.okta.com/blog/2019/06/04/what-the-heck-is-sign-in-with-apple&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2NuL3NpZ24taW4td2l0aC1hcHBsZS8=&#34;&gt;https://developer.apple.com/cn/sign-in-with-apple/&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;&lt;span class=&#34;exturl&#34; data-url=&#34;aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2RvY3VtZW50YXRpb24vc2lnbmlud2l0aGFwcGxlcmVzdGFwaS9nZW5lcmF0ZV9hbmRfdmFsaWRhdGVfdG9rZW5z&#34;&gt;https://developer.apple.com/documentation/signinwithapplerestapi/generate_and_validate_tokens&lt;/span&gt;&lt;/p&gt;
 ]]></description>
        </item>
    </channel>
</rss>
